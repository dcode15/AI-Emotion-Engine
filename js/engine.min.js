function zip(){var t=[].slice.call(arguments),e=0==t.length?[]:t.reduce(function(t,e){return t.length<e.length?t:e});return e.map(function(e,i){return t.map(function(t){return t[i]})})}function Point(t,e){this.x=t,this.y=e}function pushArray(t,e){for(var i=0;i<e.length;++i)t.push(e[i]);return t}function Evaluator(){var t=new FuzzyVar("Impact",["HighlyNegative","SlightlyNegative","NoImpact","SlightlyPositive","HighlyPositive"],[[-1.8,-1,-.2],[-.8,-.4,0],[-.25,0,.25],[0,.4,.8],[.2,1,1.8]]),e=new FuzzyVar("Importance",["NotImportant","SlightlyImportant","ExtremelyImportant"],[[-.5,0,.7],[.2,.5,.8],[.3,1,1.5]]),i=new FuzzyVar("Desirability",["HighlyUndesired","SlightlyUndesired","Neutral","SlightlyDesired","HighlyDesired"],[[-1.4,-1,-.6],[-.7,-.4,-.1],[-.3,0,.3],[.1,.4,.7],[.6,1,1.4]]),s=["Impact HighlyNegative AND Importance NotImportant THEN Desirability Neutral","Impact SlightlyNegative AND Importance NotImportant THEN Desirability Neutral","Impact NoImpact AND Importance NotImportant THEN Desirability Neutral","Impact SlightlyPositive AND Importance NotImportant THEN Desirability Neutral","Impact HighlyPositive AND Importance NotImportant THEN Desirability Neutral","Impact HighlyNegative AND Importance SlightlyImportant THEN Desirability SlightlyUndesired","Impact SlightlyNegative AND Importance SlightlyImportant THEN Desirability SlightlyUndesired","Impact NoImpact AND Importance SlightlyImportant THEN Desirability Neutral","Impact SlightlyPositive AND Importance SlightlyImportant THEN Desirability SlightlyDesired","Impact HighlyPositive AND Importance SlightlyImportant THEN Desirability SlightlyDesired","Impact HighlyNegative AND Importance ExtremelyImportant THEN Desirability HighlyUndesired","Impact SlightlyNegative AND Importance ExtremelyImportant THEN Desirability SlightlyUndesired","Impact NoImpact AND Importance ExtremelyImportant THEN Desirability Neutral","Impact SlightlyPositive AND Importance ExtremelyImportant THEN Desirability SlightlyDesired","Impact HighlyPositive AND Importance ExtremelyImportant THEN Desirability HighlyDesired"];this.fuzzy=new FuzzySystem([t,e],[i],s)}function Filter(){this.motivations={},this.rules=[]}function Engine(t,e){this.goals={},this.events={},this.standards={},this.emotionalState=new Emotions,this.name=t,this.eval=new Evaluator,this.appraiser=new Appraiser(t),this.filter=new Filter,this.decayConstant=e,this.addEvent("empty",[])}function Emotions(){this.state={Joy:0,Sad:0,Disappointment:0,Relief:0,Hope:0,Fear:0,Pride:0,Shame:0,Reproach:0,Admiration:0,Anger:0,Gratitude:0,Gratification:0,Remorse:0}}function Appraiser(t){this.name=t,this.associations={},this.userModel={},this.memory=[]}function FuzzyVar(t,e,i){this.variableName=t,this.setNames=e,this.setValues=i}function FuzzySystem(t,e,i){this.inputSets=t,this.outputSets=e,this.rules=i;for(var s=0;s<this.rules.length;s++)this.rules[s]=this.rules[s].split(" ")}function Singleton(t,e){this.xValue=t,this.membership=e}Evaluator.prototype.eventEval=function(t,e,i){for(var s=0,a=0,r=0;r<e[t].Impacts.length;){var o=e[t].Impacts[r];if(r++,o in i){var n=e[t].Impacts[r];s+=this.fuzzy.processValue([n,i[o]]).Desirability,a++}r++}return s/a},Filter.prototype.addRule=function(t){this.rules.push(t.split(" "))},Filter.prototype.setMotivation=function(t,e){this.motivations[t]=e},Filter.prototype.changeMotivation=function(t,e){this.motivations[t]+=e},Filter.prototype.applyRules=function(t){for(var e=0;e<this.rules.length;e++){var i=this.rules[e],s=!1,a=i[0],r=i[1],o=i[2];s=this.checkRelation(a,r,o);for(var n=i[3].toLowerCase(),h=4;"then"!==n;){a=i[h],h++,r=i[h],h++,o=i[h],h++;var p=this.checkRelation(a,r,o);"and"===n?s=s&&p:"or"===n&&(s=s||p),n=i[h].toLowerCase(),h++}s&&(t.state[i[h]]=0)}return t},Filter.prototype.checkRelation=function(t,e,i){var s=!1;return t in this.motivations&&("<="===e?s=this.motivations[t]<=i:"<"===e?s=this.motivations[t]<i:">="===e?s=this.motivations[t]>=i:">"===e?s=this.motivations[t]>i:"=="===e?s=this.motivations[t]===i:"!="===e&&(s=this.motivations[t]!==i)),s},Engine.prototype.addEvent=function(t,e){if(!(t in this.events)){this.events[t]={},this.appraiser.updateUserModel(this.events),this.updateExpectations(),this.events[t].Expectation=.3,this.events[t].Impacts=e;var i=this.eval.eventEval(t,this.events,this.goals);isNaN(i)&&(i=0),this.events[t].Desirability=i}},Engine.prototype.addGoal=function(t,e){this.goals[t]=e;var i;for(var s in this.events)this.events.hasOwnProperty(s)&&(i=this.eval.eventEval(s,this.events,this.goals),this.events[s].Desirability=i)},Engine.prototype.triggerEvent=function(t,e){this.emotionalState=this.appraiser.appraiseEvent(t,this.emotionalState,this.events,e),this.emotionalState=this.filter.applyRules(this.emotionalState),this.updateExpectations()},Engine.prototype.introduceObject=function(t){var e=this.appraiser.associations;for(var i in e[t])if(e[t].hasOwnProperty(i)){var s=e[t][i].Total/e[t][i].Count;this.emotionalState.state[i]+=s}},Engine.prototype.decay=function(){for(var t in this.emotionalState.state)this.emotionalState.state[t]=this.emotionalState.state[t]*this.decayConstant},Engine.prototype.setMotivation=function(t,e){this.filter.setMotivation(t,e),this.triggerEvent("empty",[])},Engine.prototype.changeMotivation=function(t,e){this.filter.changeMotivation(t,e),this.triggerEvent("empty",[])},Engine.prototype.addFilter=function(t){this.filter.addRule(t),this.triggerEvent("empty",[])},Engine.prototype.provideFeedback=function(t,e){t in this.standards?(this.standards[t].Overall+=e,this.standards[t].Count++):(this.standards[t]={},this.standards[t].Overall=e,this.standards[t].Count=1)},Engine.prototype.triggerBehavior=function(t,e){this.emotionalState=this.appraiser.appraiseBehavior(t,e,this.emotionalState,this.standards)},Engine.prototype.updateExpectations=function(){for(var t in this.events)this.events.hasOwnProperty(t)&&(this.events[t].Expectation=this.appraiser.getExpectation(t))},Engine.prototype.getEmotions=function(){return this.emotionalState.state},Appraiser.prototype.appraiseEvent=function(t,e,i,s){var a=e,r={};if(this.updateMemory(t),i[t].Desirability>0){var o=1.7*Math.pow(i[t].Expectation,.5)+.7*i[t].Desirability;r.Joy=o,r.Sad=0,a.state.Joy+=(3-a.state.Joy)*(o/3)}else if(i[t].Desirability<0){var n=2*Math.pow(i[t].Expectation,2)-i[t].Desirability;r.Sad=n,r.Joy=0,a.state.Sad+=(3-a.state.Sad)*(n/3)}else 0===i[t].Desirability&&(r.Sad=0,r.Joy=0);return r.Fear=this.calculateFear(i),a.state.Fear=r.Fear,r.Hope=this.calculateHope(i),a.state.Hope=r.Hope,a.state.Anger=Math.min(a.state.Sad,a.state.Reproach),r.Anger=a.state.Anger,a.state.Gratitude=Math.min(a.state.Joy,a.state.Admiration),r.Gratitude=a.state.Gratitude,a.state.Gratification=Math.min(a.state.Joy,a.state.Pride),r.Gratification=a.state.Gratification,a.state.Remorse=Math.min(a.state.Sad,a.state.Shame),r.Remorse=a.state.Remorse,this.updateAssociations(s,r),a},Appraiser.prototype.appraiseBehavior=function(t,e,i,s){var a=i;if(t in s){var r=s[t].Overall/s[t].Count;e===this.name?r>=0?a.state.Pride+=(3-a.state.Pride)*(r/3):a.state.Shame+=(3-a.state.Shame)*(-1*r/3):r>=0?a.state.Admiration+=(3-a.state.Admiration)*(r/3):a.state.Reproach+=(3-a.state.Reproach)*(-1*r/3)}return a},Appraiser.prototype.calculateFear=function(t){var e=0;for(var i in t)if(t.hasOwnProperty(i)){var s=0;t[i].Desirability<0&&(s=1.85*Math.pow(t[i].Expectation,2)-t[i].Desirability),s>e&&(e=s)}return e},Appraiser.prototype.calculateHope=function(t){var e=0;for(var i in t)if(t.hasOwnProperty(i)){var s=0;t[i].Desirability>0&&(s=1.55*Math.pow(t[i].Expectation,.5)+.7*t[i].Desirability),s>e&&(e=s)}return e},Appraiser.prototype.updateAssociations=function(t,e){for(var i=0;i<t.length;i++){var s=t[i];if(s in this.associations)for(var a in e)e.hasOwnProperty(a)&&(this.associations[s].hasOwnProperty(a)?(this.associations[s][a].Total+=e[a],this.associations[s][a].Count++):(this.associations[s][a]={},this.associations[s][a].Total=e[a],this.associations[s][a].Count=1));else{this.associations[s]={};for(var a in e)e.hasOwnProperty(a)&&(this.associations[s][a]={},this.associations[s][a].Total=e[a],this.associations[s][a].Count=1)}}},Appraiser.prototype.updateMemory=function(t){this.memory.length<2?this.memory.push(t):2===this.memory.length?(this.memory.push(t),this.userModel[this.memory[0]][this.memory[1]][this.memory[2]]++):(this.memory[0]=this.memory[1],this.memory[1]=this.memory[2],this.memory[2]=t,this.userModel[this.memory[0]][this.memory[1]][this.memory[2]]++)},Appraiser.prototype.updateUserModel=function(t){for(var e in t)if(t.hasOwnProperty(e))for(var i in t)if(t.hasOwnProperty(i))for(var s in t)t.hasOwnProperty(s)&&(e in this.userModel?i in this.userModel[e]?s in this.userModel[e][i]||(this.userModel[e][i][s]=0):(this.userModel[e][i]={},this.userModel[e][i][s]=0):(this.userModel[e]={},this.userModel[e][i]={},this.userModel[e][i][s]=0))},Appraiser.prototype.getExpectation=function(t){if(3===this.memory.length){var e,i=this.memory[2],s=this.memory[1];if(0!==this.userModel[s][i][t]){var a=0;for(var r in this.userModel[s][i])this.userModel[s][i].hasOwnProperty(r)&&0!==this.userModel[s][i][r]&&(a+=this.userModel[s][i][r]);e=this.userModel[s][i][t]/a}else e=.3}else e=.3;return e},FuzzySystem.prototype.processValue=function(t){var e=this.convertInputToFuzzy(t),i=this.applyRules(e),s=this.defuzzify(i);return s},FuzzySystem.prototype.convertInputToFuzzy=function(t){for(var e={},i=0;i<this.inputSets.length;i++){e[this.inputSets[i].variableName]={};for(var s=this.inputSets[i].setValues,a=0;a<s.length;a++){var r,o=s[a];r=t[i]>o[0]&&t[i]<=o[1]?1/(o[1]-o[0])*(t[i]-o[0]):t[i]>o[1]&&t[i]<o[2]?1-1/(-1*o[1]+o[2])*(t[i]-o[1]):0;var n=this.inputSets[i].variableName,h=this.inputSets[i].setNames[a];e[n][h]=r}}return e},FuzzySystem.prototype.applyRules=function(t){for(var e={},i=0;i<this.outputSets.length;i++){e[this.outputSets[i].variableName]={};for(var s=this.outputSets[i].setValues,a=0;a<s.length;a++){var r=this.outputSets[i].variableName,o=this.outputSets[i].setNames[a];e[r][o]=0}}for(var n=0;n<this.rules.length;n++){for(var h="IF",p=this.rules[n],l=0,u=0;"THEN"!==h;){var m=p[l];l++;var o=p[l];l++;var y=t[m][o];"IF"===h?u=y:"AND"===h?u=Math.min(y,u):"OR"===h&&(u=Math.max(y,u)),h=p[l],l++}var r=p[l];l++;var c=p[l];l++,u>e[r][c]&&(e[r][c]=u)}return e},FuzzySystem.prototype.defuzzify=function(t){for(var e={},i=0;i<this.outputSets.length;i++){for(var s=this.outputSets[i].variableName,a=this.outputSets[i].setNames,r=[],o=0;o<a.length;o++){var n=a[o],h=t[s][n],p=(this.outputSets[i].setValues[o][0]+this.outputSets[i].setValues[o][1]+this.outputSets[i].setValues[o][2])/3,l=new Singleton(p,h);r.push(l)}e[s]=this.defuzzEstimate(r)}return e},FuzzySystem.prototype.defuzzEstimate=function(t){for(var e=0,i=0,s=0;s<t.length;s++)e+=t[s].membership;for(var s=0;s<t.length;s++){var a=t[s].membership/e;i+=a*t[s].xValue}return i};